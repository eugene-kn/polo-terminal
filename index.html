<html>

<head>
  <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-default/index.css">
  <style>
    body {
      font-family: 'Roboto', sans-serif;
    }
    
    .el-table .green {
      background: #c5e1a5;
    }
    
    .el-table .red {
      background: #ef9a9a;
    }
  </style>
  <script src="https://unpkg.com/vue/dist/vue.min.js"></script>
  <script src="https://unpkg.com/element-ui/lib/index.js"></script>
  <script>
    window.onload = () => {
      let app = new Vue({
        el: '#app',
        data: {
          btc_usd: null,

          positions: [
            {
              coin: 'VOX',
              amount: 1447.75036284,
              amount_btc: 0.00997097,
              rate_btc: null,
              worth_btc: null,
              change: null,
              pl: null
            },

            {
              coin: 'NSR',
              amount: 71250,
              amount_btc: 0.00999999,
              rate_btc: null,
              worth_btc: null,
              change: null,
              pl: null
            },

            {
              coin: 'BBR',
              amount: 71.24999999,
              amount_btc: 0.01998983,
              rate_btc: null,
              worth_btc: null,
              change: null,
              pl: null
            },

            {
              coin: 'FLDC',
              amount: 9151.37614678,
              amount_btc: 0.00999999,
              rate_btc: null,
              worth_btc: null,
              change: null,
              pl: null
            },

            {
              coin: 'CURE',
              amount: 232.08469055,
              amount_btc: 0.00998626,
              rate_btc: null,
              worth_btc: null,
              change: null,
              pl: null
            },

            {
              coin: 'NAUT',
              amount: 120.18072289,
              amount_btc: 0.00999999,
              rate_btc: null,
              worth_btc: null,
              change: null,
              pl: null
            },

            {
              coin: 'XVC',
              amount: 213.14102564,
              amount_btc: 0.0099165,
              rate_btc: null,
              worth_btc: null,
              change: null,
              pl: null
            },

            {
              coin: 'VRC',
              amount: 339.40115685,
              amount_btc: 0.00996635,
              rate_btc: null,
              worth_btc: null,
              change: null,
              pl: null
            },

            {
              coin: 'C2',
              amount: 8750,
              amount_btc: 0.00999999,
              rate_btc: null,
              worth_btc: null,
              change: null,
              pl: null
            },

            {
              coin: 'MYR',
              amount: 41562.49999999,
              amount_btc: 0.00999999,
              rate_btc: null,
              worth_btc: null,
              change: null,
              pl: null
            }
          ]
        },

        methods: {
          getRowClassName(row, index) {
            if (row.change < -5) {
              return 'red';
            } else if (row.change > 5) {
              return 'green';
            }
            
            return '';
          }
        }
      });

      updateTickerData(app);

      setTimeout(() => {
        setInterval(() => updateTickerData(app), 60000);
      }, 60000);
    };

    function updateTickerData(app) {
      console.log('Updating ticker data...');

      fetch('https://poloniex.com/public?command=returnTicker')
        .then(resp => {
          if (resp.status !== 200) {
            console.log('Failed to retrieve ticker data from Poloniex');
          }

          resp.json().then(data => {
            app.btc_usd = data['USDT_BTC'].highestBid;

            app.positions.forEach(pos => {
              let rate = data['BTC_' + pos.coin].highestBid;
              let worth = (rate * pos.amount).round(8);
              let change = (worth * 100 / pos.amount_btc - 100).round(2);
              pos.rate_btc = rate;
              pos.worth_btc = worth;
              pos.change = change;
              pos.pl = ((worth - pos.amount_btc) * app.btc_usd).round(2);
            });
          });
        })
        .catch(err => {
          console.log('Could not connect to Poloniex - ', err);
        });
    }

    Number.prototype.round = function (places) {
      return +(Math.round(this + "e+" + places) + "e-" + places);
    }
  </script>
</head>

<body>
  <div id="app">
    <h3>BTC/USD: {{ btc_usd }}</h3>

    <template>
      <el-table :data="positions" :row-class-name="getRowClassName" border style="width: 100%">
        <el-table-column prop="coin" label="Coin" width="100"></el-table-column>
        <el-table-column prop="amount" label="Amount" width="170"></el-table-column>
        <el-table-column prop="amount_btc" label="Amount (BTC)"></el-table-column>
        <el-table-column prop="rate_btc" label="Rate (BTC)"></el-table-column>
        <el-table-column prop="worth_btc" label="Worth (BTC)"></el-table-column>
        <el-table-column prop="change" label="Change"></el-table-column>
        <el-table-column prop="pl" label="P/L" width="120"></el-table-column>
      </el-table>
    </template>
  </div>
</body>

</html>